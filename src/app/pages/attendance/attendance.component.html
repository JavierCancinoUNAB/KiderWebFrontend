<section>
  <h1 class="title mb-3">Asistencia</h1>

  <!-- Clima actual (API OpenWeather) -->
  <app-weather-widget class="mb-3"></app-weather-widget>

  <!-- Paso 1: seleccionar fecha -->
  <div *ngIf="step() === 'fecha'" class="panel p-3 rounded-3 border border-danger-subtle">
    <label class="form-label text-warning">Día/Mes/Año</label>
    <app-date-picker
      [fechaISO]="fechaISO()"
      [min]="'2015-01-01'"
      [max]="'2035-12-31'"
      (fechaChange)="fechaISO.set($event)">
    </app-date-picker>
    <button type="button" class="btn btn-danger mt-2" (click)="aceptarFecha()">Aceptar</button>
  </div>

  <!-- Últimos agregados -->
  <div class="mt-3" *ngIf="recentAdded().length">
    <div class="panel p-3 rounded-3 border border-danger-subtle">
      <h6 class="text-warning m-0">Últimos registros</h6>
      <div class="d-flex flex-wrap gap-2 mt-2">
        <button class="btn btn-sm btn-outline-danger"
                *ngFor="let r of recentAdded()"
                (click)="fechaISO.set(r.fechaISO); aceptarFecha()">
          {{ r.fechaISO }}
        </button>
      </div>
    </div>
  </div>

  <!-- Paso 2: tabla de asistencia -->
  <div *ngIf="step() === 'tabla'">
    <div class="d-flex flex-wrap gap-2 my-2">
      <button class="btn btn-sm btn-outline-success" type="button" (click)="marcarTodos('PRESENTE')">Todos presentes</button>
      <button class="btn btn-sm btn-outline-secondary" type="button" (click)="marcarTodos('AUSENTE')">Todos ausentes</button>
    </div>

    <div class="table-responsive rounded-3 border border-danger-subtle">
      <table class="table table-dark table-hover align-middle m-0">
        <thead>
          <tr><th>Alumno</th><th class="text-center">Estado</th><th>Comentario</th></tr>
        </thead>
        <tbody>
          <tr *ngFor="let r of filas(); let i = index; trackBy: trackByStudent">
            <td>{{ alumnoNombre(r) }}</td>
            <td class="text-center">
              <div class="btn-group btn-group-sm">
                <button class="btn" [class.btn-success]="r.estado==='PRESENTE'" [class.btn-outline-success]="r.estado!=='PRESENTE'" type="button" (click)="setEstado(i,'PRESENTE')">Presente</button>
                <button class="btn" [class.btn-secondary]="r.estado==='AUSENTE'" [class.btn-outline-secondary]="r.estado!=='AUSENTE'" type="button" (click)="setEstado(i,'AUSENTE')">Ausente</button>
              </div>
            </td>
            <td><input class="form-control in" type="text" [ngModel]="r.comentario" (ngModelChange)="setComentario(i, $event)" placeholder="Opcional" aria-label="Comentario opcional"></td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="d-flex justify-content-between gap-2 mt-3">
      <button class="btn btn-outline-secondary" type="button">Anterior</button>
      <button class="btn btn-danger" type="button" (click)="siguiente()">Guardar y ver reporte</button>
    </div>
  </div>
</section>
